/*
 * FoxyMainPage.java
 *
 * Created on June 20, 2006, 6:18 PM
 *
 * To change this template, choose Tools | Template Manager
 * and open the template in the editor.
 */

package com.foxy.page;

import com.foxy.data.FoxyOrderDetaiData;
import com.foxy.data.FoxyReportData;
import com.foxy.db.Category;
import com.foxy.db.OrderConfirm;
import com.foxy.db.Shipping;
import com.foxy.util.ListData;
import com.lowagie.text.Rectangle;
import java.io.Serializable;
import com.foxy.bean.FoxySessionData;
import com.foxy.db.HibernateUtil;
import com.foxy.db.OrderSummary;
import com.foxy.db.Orders;
import com.foxy.db.Category;
import com.foxy.util.ListData;
import com.lowagie.text.Chunk;
import com.lowagie.text.Document;
import com.lowagie.text.DocumentException;
import com.lowagie.text.Element;
import com.lowagie.text.Font;
import com.lowagie.text.FontFactory;

import com.lowagie.text.Image;
import com.lowagie.text.PageSize;
import com.lowagie.text.Paragraph;
import com.lowagie.text.Phrase;
import com.lowagie.text.html.HtmlWriter;
import com.lowagie.text.pdf.PdfCell;
import com.lowagie.text.pdf.PdfPCell;
import com.lowagie.text.pdf.PdfPTable;
import com.lowagie.text.pdf.PdfWriter;
import java.awt.Color;
import java.io.ByteArrayOutputStream;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.MissingResourceException;
import java.util.ResourceBundle;
import java.util.Locale;
import java.util.regex.Pattern;
import javax.faces.context.ExternalContext;
import javax.faces.context.FacesContext;
import javax.faces.model.DataModel;
import javax.faces.model.ListDataModel;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import org.hibernate.classic.Session;
import java.io.File;

/**
 *
 * @author eric
 */
public class FoxyReportPage extends Page implements Serializable {
    private static String MENU_CODE = new String("FOXY");
    
    private Date fromDate;
    private Date toDate;
    private String country;
    private String merchandiser;
    private String shipStat;
    
    private String curOrdId = null;
    private DataModel orderDetailModel;
    
    private String orderId;
    private ResourceBundle foxyParam = null;
    
    
    /** Creates a new instance of FoxyReportSummary */
    public FoxyReportPage() {
        super(new String("OrderReportForm"));
        try {
            /* Get session data */
            if (this.foxySessionData == null) {
                this.foxySessionData = (FoxySessionData) getBean("foxySessionData");
            }
            this.foxySessionData.setAction(SCH);
            curOrdId = this.foxySessionData.getOrderId();
            
            Locale defaultEng = new Locale("en");
            //Always fixed to Eng, else path may have problems
            foxyParam = ResourceBundle.getBundle("Foxy", defaultEng);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private String getFoxyParam(String key){
        String val = null;
        try {
            val = foxyParam.getString(key);
        } catch ( MissingResourceException e ) {
            //e.printStackTrace();
            System.err.println("Parameter key [" + key + "] not found");
        }finally {
            
        }
        return  val;
    }
    
    
    public String OrderEntryForm() {
        HttpServletResponse resp =(HttpServletResponse)this.ectx.getResponse();
        ServletOutputStream out = null;
        PdfPCell cell = null;
        String filename = null;  //File name to keep for imtermediate file
        String filepath = null;
        
        
        SimpleDateFormat fmt = new SimpleDateFormat("EEE, d MMM yyyy HH:mm:ss");
        SimpleDateFormat fmt2 = new SimpleDateFormat("dd-MMM-yyyy");
        Date dNow = new Date();
        
        Font font18 = new Font(Font.HELVETICA, 18);
        Font font14 = new Font(Font.HELVETICA, 14);
        Font font16 = new Font(Font.HELVETICA, 16);
        Font font12 = new Font(Font.HELVETICA, 12);
        Font font10 = new Font(Font.HELVETICA, 10);
        Font font8 = new Font(Font.HELVETICA, 8);
        Font font7 = new Font(Font.HELVETICA, 7);
        Font font6 = new Font(Font.HELVETICA, 6);
        
        Font tblHeader = new Font(Font.HELVETICA, 8);
        Font tblBody = new Font(Font.HELVETICA, 8);
        
        Rectangle border_l = new Rectangle(0f, 0f);
        //border_l.setBorderWidth(3);
        border_l.setBorderWidthLeft(1f);
        border_l.setBorderWidthBottom(0f);
        border_l.setBorderWidthRight(0f);
        border_l.setBorderWidthTop(1f);
        border_l.setBorderColor(Color.GRAY);
        //border_l.setBorderColorLeft(Color.RED);
        
        Rectangle border_lc = new Rectangle(0f, 0f);
        border_lc.setBorderWidthLeft(0f);
        border_lc.setBorderWidthBottom(0f);
        border_lc.setBorderWidthRight(1f);
        border_lc.setBorderWidthTop(1f);
        border_lc.setBorderColor(Color.GRAY);
        
        Rectangle border_rc = new Rectangle(0f, 0f);
        border_rc.setBorderWidthLeft(0f);
        border_rc.setBorderWidthBottom(0f);
        border_rc.setBorderWidthRight(0f);
        border_rc.setBorderWidthTop(1f);
        border_rc.setBorderColor(Color.GRAY);
        
        Rectangle border_r = new Rectangle(0f, 0f);
        border_r.setBorderWidthLeft(0f);
        border_r.setBorderWidthBottom(0f);
        border_r.setBorderWidthRight(1f);
        border_r.setBorderWidthTop(1f);
        border_r.setBorderColor(Color.GRAY);
        
        Rectangle detail_r = new Rectangle(0f, 0f);
        detail_r.setBorderWidthLeft(0f);
        detail_r.setBorderWidthBottom(1f);
        detail_r.setBorderWidthRight(0f);
        detail_r.setBorderWidthTop(0f);
        
        
        Document document = new Document();
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        
        try {
            filepath = this.getFoxyParam("FileUploadPath");
            filename = filepath + File.separatorChar +  this.curOrdId + ".jpg";
            
            File f  =  new File(filename);
            if ( f.exists() == false){
                filename = filepath + File.separatorChar + "default.jpg";
            }
            
            //Image img = Image.getInstance(new URL("http://localhost:8084" + this.ectx.getRequestContextPath() + "/images/logo.png"));
            Image img = Image.getInstance(filename);
            img.setBorder(1);
            img.scalePercent(100);
            img.scaleAbsoluteHeight(5000);
            
            PdfWriter writer = PdfWriter.getInstance(document, baos);
            document.open();
            //if (requ.getParameter("preview") == null)
            //    writer.addJavaScript("this.print(false);", false);
            
            
            /* Content Here */
            PdfPTable datatable = new PdfPTable(4);     // Create table with 4 columns
            PdfPTable innertable = new PdfPTable(2);
            
            PdfPTable toptable = new PdfPTable(2);
            PdfPTable headertable = new PdfPTable(2);
            
            PdfPTable detailtable = new PdfPTable(8);
            PdfPTable footertable = new PdfPTable(3);
            
            int colWidths[] = { 15, 35, 15, 35 };   // Column width
            
            int headerColWidths[] = { 60, 40 };   // Column width
            headertable.setWidths(headerColWidths);
            headertable.setWidthPercentage(100); // percentage
            headertable.getDefaultCell().setBorder(0);
            headertable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_RIGHT);
            headertable.getDefaultCell().setVerticalAlignment(Element.ALIGN_BOTTOM);
            
            int topColWidths[] = { 70, 30 };   // Column width
            toptable.setWidths(topColWidths);
            toptable.setWidthPercentage(100); // percentage
            toptable.getDefaultCell().setBorder(0);
            toptable.getDefaultCell().setFixedHeight(100);
            toptable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_LEFT);
            toptable.getDefaultCell().setVerticalAlignment(Element.ALIGN_CENTER);
            
            int innerColWidths[] = { 30, 70 };   // Column width
            innertable.setWidths(innerColWidths);
            innertable.setWidthPercentage(100); // percentage
            innertable.getDefaultCell().setBorder(0);
            innertable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_LEFT);
            innertable.getDefaultCell().setVerticalAlignment(Element.ALIGN_CENTER);
            
            datatable.setWidths(colWidths);
            datatable.setWidthPercentage(100); // percentage
            datatable.getDefaultCell().setPadding(3);
            datatable.getDefaultCell().setBorderWidth(1);
            datatable.getDefaultCell().setBorderColor(Color.GRAY);
            datatable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_LEFT);
            datatable.getDefaultCell().setVerticalAlignment(Element.ALIGN_CENTER);
            
            int detailColWidths[] = { 10, 28, 20, 16, 16, 12, 12, 16 };   // Column width
            detailtable.setWidths(detailColWidths);
            detailtable.setWidthPercentage(100); // percentage
            detailtable.getDefaultCell().setPadding(3);
            detailtable.getDefaultCell().setBorder(0);
            detailtable.getDefaultCell().setBorderWidthBottom(1);
            detailtable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_LEFT);
            detailtable.getDefaultCell().setVerticalAlignment(Element.ALIGN_CENTER);
            
            
            int footerColWidths[] = { 35, 35, 30 };   // Column width
            footertable.setWidths(footerColWidths);
            footertable.setWidthPercentage(100); // percentage
            footertable.getDefaultCell().setBorder(0);
            footertable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_LEFT);
            footertable.getDefaultCell().setVerticalAlignment(Element.ALIGN_TOP);
            
            
            headertable.addCell(new Phrase("Order Entry Form", font12));
            headertable.addCell(new Phrase("Printed by " + this.getUserId() + " on " + fmt.format(dNow), font7));
            
            // Get data from database
            Session session = (Session) HibernateUtil.currentSession(super.getUserId());
            List order = session.createQuery("from Orders where orderid = '" + curOrdId + "'").list();
            
            // Populate table with data
            for (int i = 0; i < order.size(); i ++ ){
                Orders ord = (Orders) order.get(i);
                
                cell = new PdfPCell(new Phrase("CHIN HENG GARMENTS FACTORY PTE LTD", font12));
                cell.setColspan(1);
                cell.setBorder(0);
                cell.setVerticalAlignment(Element.ALIGN_BOTTOM);
                toptable.addCell(cell);
                
                cell = new PdfPCell(img, true);
                cell.setColspan(1);
                cell.setBorder(0);
                toptable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Customer Code", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getCustCode(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Merchandiser", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getMerchandiser(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("Brand/Division", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getCustBrand() + " / " + ord.getCustDivision(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("NEW ORDER", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("/ AMENDMENT / STOCK / CANCEL", font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Style No", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getStyleCode(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Unit Price", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": US$" + ord.getUnitPrice() + "/pc", font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("Our Ref #", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getOrderId(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Price Term", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getPriceTerm(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Ord Date", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + fmt2.format(ord.getOrderDate()), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Season", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getSeason(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Description", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getDescription(), font10));
                cell.cloneNonPositionParameters(border_lc);
                cell.setColspan(3); //span across all the rest of 3 col (to force int occupy full row)
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Fabrication", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getFabrication(), font10));
                cell.cloneNonPositionParameters(border_lc);
                cell.setColspan(3); //span across all the rest of 3 col (to force int occupy full row)
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Fabric Mill", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase(": " + ord.getFabricMill(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("", font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("Fabric YY/DZ", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getFabricYyDz(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Wash Type", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getWash(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Fabric Price", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getFabricPrice(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Wash Cost", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getSwash(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("Average CMT", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getCmt(), font10));
                cell.cloneNonPositionParameters(border_lc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("Graphic/EMB Cost", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getGcost(), font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
                
                border_l.setBorderWidthBottom(1f);
                border_lc.setBorderWidthBottom(1f);
                border_rc.setBorderWidthBottom(1f);
                border_r.setBorderWidthBottom(1f);
                
                cell = new PdfPCell(new Phrase("Remark", font10));
                cell.cloneNonPositionParameters(border_l);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase(": " + ord.getRemark(), font10));
                cell.cloneNonPositionParameters(border_lc);
                cell.setColspan(3); //span across all the rest of 3 col (to force int occupy full row)
                datatable.addCell(cell);
                
                
                cell = new PdfPCell(new Phrase("", font10));
                cell.cloneNonPositionParameters(border_rc);
                datatable.addCell(cell);
                
                cell = new PdfPCell(new Phrase("", font10));
                cell.cloneNonPositionParameters(border_r);
                datatable.addCell(cell);
            }
            
            // Get data from database
            ListData ld = (ListData)getBean("listData");
            List orders = session.createQuery("from OrderSummary where orderid = '" + curOrdId + "'").list();
            
            detailtable.addCell(new Phrase("SubRef #", tblHeader));
            //Right align col header
            cell = new PdfPCell(new Phrase("Quantity", tblHeader));
            cell.setHorizontalAlignment(Element.ALIGN_RIGHT);
            cell.setPaddingRight(10f);
            cell.cloneNonPositionParameters(detail_r);
            detailtable.addCell(cell);
            
            detailtable.addCell(new Phrase("Delivery", tblHeader));
            detailtable.addCell(new Phrase("Destination", tblHeader));
            detailtable.addCell(new Phrase("Category", tblHeader));
            detailtable.addCell(new Phrase("Quota", tblHeader));
            detailtable.addCell(new Phrase("Ship By", tblHeader));
            detailtable.addCell(new Phrase("C/O", tblHeader));
            
            datatable.setHeaderRows(1); // this is the end of the table header
            
            
            Category cat = null;
            for (int i = 0; i < orders.size(); i ++ ){
                OrderSummary ords = (OrderSummary) orders.get(i);
                detailtable.addCell(new Phrase(ords.getMonth() + ords.getLocation(), font10));
                
                //Dynamic quantity column
                if ( "PCS".equals(ords.getUnitc())){
                    cell = new PdfPCell(new Phrase(ords.getQtyDzn().toString() + " pcs", font10));
                }else {
                    cell = new PdfPCell(new Phrase(ords.getQtyPcs().toString() + " dzn", font10));
                }
                cell.setHorizontalAlignment(Element.ALIGN_RIGHT);
                cell.setPaddingRight(10f);
                cell.cloneNonPositionParameters(detail_r);
                detailtable.addCell(cell);
                
                
                detailtable.addCell(new Phrase(fmt2.format(ords.getDelivery()), font10));
                detailtable.addCell(new Phrase(ld.getDestinationDesc(ords.getDestination(), 1), font10));
                cat = ld.getCategory(ords.getCategory(), 1);
                if ( cat != null){
                    detailtable.addCell(new Phrase(cat.getCategory(), font10));
                }else {
                    detailtable.addCell(new Phrase("Unkown", font10));
                }
                detailtable.addCell(new Phrase(ords.getImportTax(), font10));
                detailtable.addCell(new Phrase(ords.getShip(), font10));
                detailtable.addCell(new Phrase(ld.getCountryDesc(ords.getOrigin(), 1), font10));
            }
            
            footertable.addCell(new Phrase("Checked By : ________________", font10));
            footertable.addCell(new Phrase("Confirmed By : ________________", font10));
            footertable.addCell(new Phrase("Prepared By : ________________", font10));
            
            
            document.add(headertable);
            document.add(new Paragraph(" "));
            document.add(toptable);
            document.add(new Paragraph(" "));
            document.add(datatable);
            document.add(new Paragraph(" "));
            document.add(detailtable);
            document.add(new Paragraph(" "));
            document.add(footertable);
            document.add(new Paragraph(" "));
            document.add(new Paragraph("Please refer to appendix for detail if any [ YES / NO ]",font10));
            document.close();
        } catch (DocumentException e) {
            e.printStackTrace();
        } catch (Exception e) {
            e.printStackTrace();
        }
        resp.setContentType("application/pdf");
        resp.setHeader("Content-Disposition", "attachment; filename=" + curOrdId + ".pdf");
        resp.setContentLength(baos.size());
        
        try {
            out = resp.getOutputStream();
            baos.writeTo(out);
            out.flush();
            out.close();
        } catch (Exception e){
            e.printStackTrace();
        } finally {
            HibernateUtil.closeSession();
        }
        this.ctx.responseComplete();
        return null;
    }
    
    public DataModel getProductionReport() {
        Double totalDzn = new Double(0.0);
        Double totalPcs = new Double(0.0);
        ListData ld = (ListData)getBean("listData");
        Shipping sp = null;
        Date dNow = new Date();
        SimpleDateFormat fmt = new SimpleDateFormat("M");
        Integer month = null;
        
        if (this.foxySessionData.getPageParameter() == null) {
            System.out.println(fmt.format(dNow));
            month = Integer.parseInt(fmt.format(dNow));
            this.foxySessionData.setPageParameter(fmt.format(dNow));
        } else {
            System.out.println(this.foxySessionData.getPageParameter());
            month = Integer.parseInt(this.foxySessionData.getPageParameter());
        }
        try {
            Session session = (Session) HibernateUtil.currentSession();
            //List ordSum = session.createQuery("from OrderSummary where orderid = '061001' order by month").list();
            List ordCon = session.createQuery("from OrderConfirm where closedate between '" +
                    this.getFromDateDb() + "' and '" +
                    this.getToDateDb() + "' and make = '" +
                    this.getCountry() + "'").list();
            //List ordCon = session.createQuery("from OrderConfirm where month(closedate) = " + month).list();
            if (ordCon.size() <= 0) {
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            for (int i = 0; i < ordCon.size(); i ++ ){
                FoxyReportData odDs = new FoxyReportData();
                OrderConfirm oc = (OrderConfirm) ordCon.get(i);
                
                List ship = session.createQuery("from Shipping where crefid = " + oc.getId()).list();
                if (ship.size() > 0) {
                    sp = (Shipping) ship.get(0);
                } else {
                    continue;
                }
                
                List ordSum = session.createQuery("from OrderSummary where srefid = " + oc.getSsRefId() + " order by month").list();
                OrderSummary os = (OrderSummary) ordSum.get(0);
                
                List ord = session.createQuery("from Orders where orderid = '" + oc.getOrderId() + "'").list();
                Orders orders = (Orders) ord.get(0);
                
                List result = session.createQuery("from Category where catId = '" + os.getCategory() +"'").list();
                Category cat = (Category) result.get(0);
                odDs.setCategory(cat.getCategory());
                System.out.println("$$$$$$$$$$ " + odDs.getCategory() + " **** " + os.getCategory());
                
                odDs.setMonth(os.getMonth());
                odDs.setLocation(os.getLocation());
                odDs.setSubLocation(oc.getSubLocation());
                odDs.setOrderId(orders.getOrderId());
                odDs.setPoNumber(oc.getPoNumber());
                odDs.setStyle(orders.getStyleCode());
                odDs.setCustomer(orders.getCustCode());
                odDs.setCloseDate(oc.getCloseDate());
                odDs.setDestName(ld.getDestinationDesc(os.getDestination(), 1));
                odDs.setDestShortName(ld.getDestinationShortDesc(os.getDestination(), 1));
                
                odDs.setMake(ld.getCountryDesc(os.getOrigin(), 1));
                odDs.setRemark(os.getRemark());
                odDs.setQuantityDzn(os.getQtyDzn());
                odDs.setQuantityPcs(os.getQtyPcs());
                odDs.setUnit(os.getUnit());
                odDs.setEtd(sp.getEtd());
                odDs.setShip(os.getShip());
                this.tableList.add(odDs);
                
            }
            if (orderDetailModel == null) {
                orderDetailModel = new ListDataModel();
            }
            orderDetailModel.setWrappedData(tableList);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return orderDetailModel;
    }
    
    public DataModel getMerchandiserReport() {
        Double totalDzn = new Double(0.0);
        Double totalPcs = new Double(0.0);
        ListData ld = (ListData)getBean("listData");
        Shipping sp = null;
        Date dNow = new Date();
        SimpleDateFormat fmt = new SimpleDateFormat("M");
        Integer month = null;
        
        if (this.foxySessionData.getPageParameter() == null) {
            System.out.println(fmt.format(dNow));
            month = Integer.parseInt(fmt.format(dNow));
            this.foxySessionData.setPageParameter(fmt.format(dNow));
        } else {
            System.out.println(this.foxySessionData.getPageParameter());
            month = Integer.parseInt(this.foxySessionData.getPageParameter());
        }
        try {
            Session session = (Session) HibernateUtil.currentSession();
            List ord = session.createQuery("from Orders where orderdate between '" +
                    this.getFromDateDb() + "' and '" +
                    this.getToDateDb() + "' and merchandiser = '" +
                    this.getMerchandiser() + "'").list();
            if (ord.size() <= 0) {
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            for (int i = 0; i < ord.size(); i ++ ){
                //FoxyReportData odDs = new FoxyReportData();
                Orders orders = (Orders) ord.get(i);
                
                List ordSum = session.createQuery("from OrderSummary where orderid = '" + orders.getOrderId() + "' order by month").list();
                if (ordSum.size() > 0) {
                    for (int j = 0; j < ordSum.size(); j ++ ){
                        FoxyReportData odDs = new FoxyReportData();
                        OrderSummary os = (OrderSummary) ordSum.get(j);
                        
                        odDs.setOrderId(orders.getOrderId());
                        odDs.setCustomer(orders.getCustCode());
                        odDs.setStyle(orders.getStyleCode());
                        
                        List result = session.createQuery("from Category where catId = '" + os.getCategory() +"'").list();
                        Category cat = (Category) result.get(0);
                        odDs.setCategory(cat.getCategory());
                        
                        odDs.setMonth(os.getMonth());
                        odDs.setLocation(os.getLocation());
                        
                        odDs.setMake(ld.getCountryDesc(os.getOrigin(), 1));
                        odDs.setDestShortName(ld.getDestinationShortDesc(os.getDestination(), 1));
                        odDs.setDestName(ld.getDestinationDesc(os.getDestination(), 1));
                        odDs.setRemark(os.getRemark());
                        odDs.setQuantityDzn(os.getQtyDzn());
                        odDs.setQuantityPcs(os.getQtyPcs());
                        
                        List ordCon = session.createQuery("from OrderConfirm where srefid = " + os.getId()).list();
                        for (int x = 0; x < ordCon.size(); x ++ ){
                            OrderConfirm oc = (OrderConfirm) ordCon.get(x);
                            
                            odDs.setSubLocation(oc.getSubLocation());
                            odDs.setPoNumber(oc.getPoNumber());
                            odDs.setCloseDate(oc.getCloseDate());
                            
                            List ship = session.createQuery("from Shipping where crefid = " + oc.getId()).list();
                            if (ship.size() > 0) {
                                sp = (Shipping) ship.get(0);
                                odDs.setShip(os.getShip());
                            }
                        }
                        this.tableList.add(odDs);
                    }
                } else {
                    FoxyReportData odDs = new FoxyReportData();
                    odDs.setOrderId(orders.getOrderId());
                    odDs.setCustomer(orders.getCustCode());
                    odDs.setStyle(orders.getStyleCode());
                    this.tableList.add(odDs);
                }
            }
            if (orderDetailModel == null) {
                orderDetailModel = new ListDataModel();
            }
            orderDetailModel.setWrappedData(tableList);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return orderDetailModel;
    }
    
    public DataModel getQuantityCheckList() {
        Double totalDzn = new Double(0.0);
        Double totalPcs = new Double(0.0);
        ListData ld = (ListData)getBean("listData");
        Shipping sp = null;
        Date dNow = new Date();
        SimpleDateFormat fmt = new SimpleDateFormat("M");
        Integer month = null;
        Integer recCount = new Integer(0);
        
        if (this.foxySessionData.getPageParameter() == null) {
            System.out.println(fmt.format(dNow));
            month = Integer.parseInt(fmt.format(dNow));
            this.foxySessionData.setPageParameter(fmt.format(dNow));
        } else {
            System.out.println(this.foxySessionData.getPageParameter());
            month = Integer.parseInt(this.foxySessionData.getPageParameter());
        }
        try {
            Session session = (Session) HibernateUtil.currentSession();
            List ord = session.createQuery("from Orders where orderdate between '" +
                    this.getFromDateDb() + "' and '" +
                    this.getToDateDb() + "'").list();
            if (ord.size() <= 0) {
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            for (int i = 0; i < ord.size(); i ++ ){
                //FoxyReportData odDs = new FoxyReportData();
                Orders orders = (Orders) ord.get(i);
                System.out.println(orders.getOrderId());
                List ordSum = session.createQuery("from OrderSummary where orderid = '" +
                        orders.getOrderId() + "' and origin = '" +
                        this.getCountry() + "' order by month").list();
                if (ordSum.size() > 0) {
                    for (int j = 0; j < ordSum.size(); j ++ ){
                        FoxyReportData odDs = new FoxyReportData();
                        OrderSummary os = (OrderSummary) ordSum.get(j);
                        System.out.println(os.getMonth());
                        
                        odDs.setOrderId(orders.getOrderId());
                        odDs.setCustomer(orders.getCustCode());
                        odDs.setStyle(orders.getStyleCode());
                        
                        List result = session.createQuery("from Category where catId = '" + os.getCategory() +"'").list();
                        Category cat = (Category) result.get(0);
                        odDs.setCategory(cat.getCategory());
                        
                        odDs.setMonth(os.getMonth());
                        odDs.setLocation(os.getLocation());
                        
                        odDs.setMake(ld.getCountryDesc(os.getOrigin(), 1));
                        odDs.setDestShortName(ld.getDestinationShortDesc(os.getDestination(), 1));
                        odDs.setDestName(ld.getDestinationDesc(os.getDestination(), 1));
                        odDs.setRemark(os.getRemark());
                        odDs.setQuantityDzn(os.getQtyDzn());
                        odDs.setQuantityPcs(os.getQtyPcs());
                        odDs.setLotQty(os.getQtyDzn());
                        
                        List ordCon = session.createQuery("from OrderConfirm where srefid = " + os.getId()).list();
                        for (int x = 0; x < ordCon.size(); x ++ ){
                            OrderConfirm oc = (OrderConfirm) ordCon.get(x);
                            
                            odDs.setSubLocation(oc.getSubLocation());
                            odDs.setPoNumber(oc.getPoNumber());
                            odDs.setCloseDate(oc.getCloseDate());
                            odDs.setMrQty(oc.getQtyDzn());
                            
                            
                            List ship = session.createQuery("from Shipping where crefid = " + oc.getId()).list();
                            if (ship.size() > 0) {
                                sp = (Shipping) ship.get(0);
                                odDs.setShip(os.getShip());
                                odDs.setShipQty(sp.getQtyDzn());
                            }
                        }
                        this.tableList.add(odDs);
                        recCount ++;
                    }
                }
            }
            if (recCount == 0){
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            if (orderDetailModel == null) {
                orderDetailModel = new ListDataModel();
            }
            orderDetailModel.setWrappedData(tableList);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return orderDetailModel;
    }
    
    public DataModel getFtaReport() {
        Double totalDzn = new Double(0.0);
        Double totalPcs = new Double(0.0);
        ListData ld = (ListData)getBean("listData");
        Shipping sp = null;
        Date dNow = new Date();
        SimpleDateFormat fmt = new SimpleDateFormat("M");
        Integer month = null;
        Integer recCount = new Integer(0);
        
        if (this.foxySessionData.getPageParameter() == null) {
            System.out.println(fmt.format(dNow));
            month = Integer.parseInt(fmt.format(dNow));
            this.foxySessionData.setPageParameter(fmt.format(dNow));
        } else {
            System.out.println(this.foxySessionData.getPageParameter());
            month = Integer.parseInt(this.foxySessionData.getPageParameter());
        }
        try {
            Session session = (Session) HibernateUtil.currentSession();
            List ordCon = session.createQuery("from OrderConfirm where closedate between '" +
                    this.getFromDateDb() + "' and '" +
                    this.getToDateDb() + "' and make = '" +
                    this.getCountry() + "'").list();
            if (ordCon.size() <= 0) {
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            for (int i = 0; i < ordCon.size(); i ++ ){
                FoxyReportData odDs = new FoxyReportData();
                OrderConfirm oc = (OrderConfirm) ordCon.get(i);
                System.out.println(oc.getOrderId());
                System.out.println(this.getShipStat());
                List ship = session.createQuery("from Shipping where crefid = " + oc.getId() + " and shipstat = '" + this.getShipStat() + "'").list();
                if (ship.size() > 0) {
                    sp = (Shipping) ship.get(0);
                    recCount ++;
                } else {
                    continue;
                }
                
                List ordSum = session.createQuery("from OrderSummary where srefid = " + oc.getSsRefId() + " order by month").list();
                OrderSummary os = (OrderSummary) ordSum.get(0);
                
                List ord = session.createQuery("from Orders where orderid = '" + oc.getOrderId() + "'").list();
                Orders orders = (Orders) ord.get(0);
                
                List result = session.createQuery("from Category where catId = '" + os.getCategory() +"'").list();
                Category cat = (Category) result.get(0);
                odDs.setCategory(cat.getCategory());
                System.out.println("$$$$$$$$$$ " + odDs.getCategory() + " **** " + os.getCategory());
                
                odDs.setMonth(os.getMonth());
                odDs.setLocation(os.getLocation());
                odDs.setSubLocation(oc.getSubLocation());
                odDs.setOrderId(orders.getOrderId());
                odDs.setPoNumber(oc.getPoNumber());
                odDs.setStyle(orders.getStyleCode());
                odDs.setCustomer(orders.getCustCode());
                odDs.setCloseDate(oc.getCloseDate());
                odDs.setDestName(ld.getDestinationDesc(os.getDestination(), 1));
                odDs.setDestShortName(ld.getDestinationShortDesc(os.getDestination(), 1));
                
                odDs.setMake(ld.getCountryDesc(os.getOrigin(), 1));
                odDs.setRemark(os.getRemark());
                odDs.setQuantityDzn(sp.getQtyDzn());
                odDs.setQuantityPcs(sp.getQtyPcs());
                odDs.setUnit(os.getUnit());
                odDs.setEtd(sp.getEtd());
                odDs.setShip(os.getShip());
                this.tableList.add(odDs);
                
            }
            if (recCount == 0) {
                FoxyReportData odDs = new FoxyReportData();
                this.tableList.add(odDs);
            }
            if (orderDetailModel == null) {
                orderDetailModel = new ListDataModel();
            }
            orderDetailModel.setWrappedData(tableList);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return orderDetailModel;
    }
    
    public void test2() {
        HttpServletResponse resp =(HttpServletResponse)this.ectx.getResponse();
        ServletOutputStream out = null;
        
        //Document document = new Document();
        Document document = new Document(PageSize.A4.rotate(), 10, 10, 10, 10);
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        
        try {
            PdfWriter writer = PdfWriter.getInstance(document, baos);
            //HtmlWriter writer = HtmlWriter.getInstance(document, baos);
            document.open();
            
            FontFactory.getFont(FontFactory.HELVETICA, 8, Font.ITALIC, new Color(0x00, 0x00, 0xFF));
            // step4
            String[] bogusData = { "M0065920", "SL", "FR86000P", "PCGOLD",
            "119000", "96 06", "2001-08-13", "4350", "6011648299",
            "FLFLMTGP", "153", "119000.00" };
            int NumColumns = 12;
            //if (requ.getParameter("preview") == null)
            //    writer.addJavaScript("this.print(false);", false);
            /* Content Here */
            PdfPTable datatable = new PdfPTable(NumColumns);
            int headerwidths[] = { 4, 6, 8, 8, 8, 8, 8, 8, 8, 8, 8, 18  }; // percentage
            datatable.setWidths(headerwidths);
            datatable.setWidthPercentage(100); // percentage
            datatable.getDefaultCell().setPadding(1);
            datatable.getDefaultCell().setBorderWidth(1);
            datatable.getDefaultCell().setHorizontalAlignment(Element.ALIGN_CENTER);
            
            Font tblHeader = new Font(Font.HELVETICA, 8);
            Font tblBody = new Font(Font.HELVETICA, 8);
            
            datatable.addCell(new Phrase("Ref #", tblHeader));
            datatable.addCell(new Phrase("Ord Date", tblHeader));
            datatable.addCell(new Phrase("Customer", tblHeader));
            datatable.addCell(new Phrase("Style", tblHeader));
            datatable.addCell(new Phrase("Season", tblHeader));
            datatable.addCell(new Phrase("M.R", tblHeader));
            datatable.addCell(new Phrase("Price", tblHeader));
            datatable.addCell(new Phrase("C.O", tblHeader));
            datatable.addCell(new Phrase("ITax", tblHeader));
            datatable.addCell(new Phrase("Qty (DZN)", tblHeader));
            datatable.addCell(new Phrase("Qty (PCS)", tblHeader));
            datatable.addCell(new Phrase("Dest", tblHeader));
            
            
            datatable.setHeaderRows(1); // this is the end of the table header
            
            datatable.getDefaultCell().setBorderWidth(1);
            
            
            Session session = (Session) HibernateUtil.currentSession(super.getUserId());
            List order = session.createQuery("from Orders where orderid = '" + curOrdId + "'").list();
            for (int i = 0; i < order.size(); i ++ ){
                Orders ord = (Orders) order.get(i);
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderDate().toString(), tblBody));
                datatable.addCell(new Phrase(ord.getCustCode(), tblBody));
                datatable.addCell(new Phrase(ord.getStyleCode(), tblBody));
                datatable.addCell(new Phrase(ord.getSeason(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                datatable.addCell(new Phrase(ord.getOrderId(), tblBody));
                
                List ordSum = session.createQuery("from OrderSummary where orderid = '" + ord.getOrderId() +"'").list();
                for (int j = 0; j < ordSum.size(); j ++ ){
                    //FoxyOrderDetaiData odDs = new FoxyOrderDetaiData();
                    OrderSummary os = (OrderSummary) ordSum.get(j);
                    datatable.getDefaultCell().setGrayFill(0.9f);
                    datatable.addCell(new Phrase(os.getMonth() + os.getLocation(), tblBody));
                    datatable.addCell(new Phrase(""));
                    datatable.addCell(new Phrase(os.getDestination(), tblBody));
                    datatable.addCell(new Phrase(os.getImportTax(), tblBody));
                    datatable.addCell(new Phrase(os.getOrigin(), tblBody));
                    datatable.addCell(new Phrase(os.getRemark(), tblBody));
                    datatable.addCell(new Phrase(os.getUnit(), tblBody));
                    datatable.addCell(new Phrase(os.getQtyDzn().toString(), tblBody));
                    datatable.addCell(new Phrase(os.getQtyPcs().toString(), tblBody));
                    datatable.addCell(new Phrase(os.getOrderId(), tblBody));
                    datatable.addCell(new Phrase(os.getOrderId(), tblBody));
                    datatable.addCell(new Phrase(os.getOrderId(), tblBody));
                }
            }
            
            /*for (int i = 1; i < 750; i++) {
                if (i % 2 == 1) {
                    datatable.getDefaultCell().setGrayFill(0.9f);
                }
                for (int x = 0; x < NumColumns; x++) {
                    datatable.addCell(new Phrase(bogusData[x], tblBody));
                }
                if (i % 2 == 1) {
                    datatable.getDefaultCell().setGrayFill(0.9f);
                }
            }*/
            document.add(datatable);
            document.close();
        } catch (DocumentException e) {
            e.printStackTrace();
        }
        
        resp.setContentType("application/pdf");
        //resp.setContentType("text/html");
        resp.setHeader("Content-Disposition", "attachment");
        
        
        resp.setContentLength(baos.size());
        try {
            out = resp.getOutputStream();
            baos.writeTo(out);
            out.flush();
        } catch (Exception e){
            e.printStackTrace();
        }
        this.ctx.responseComplete();
    }
    
    public String getMonth() {
        if (this.foxySessionData.getPageParameter() == null) {
            Date dNow = new Date();
            SimpleDateFormat fmt = new SimpleDateFormat("M");
            return(fmt.format(dNow));
        } else {
            return this.foxySessionData.getPageParameter();
        }
    }
    
    public String PrevMonth() {
        this.foxySessionData.setPageParameter(String.valueOf(Integer.parseInt(this.foxySessionData.getPageParameter()) - 1));
        System.out.println("!!!! " + this.foxySessionData.getPageParameter());
        return ("success");
    }
    
    public String NextMonth() {
        this.foxySessionData.setPageParameter(String.valueOf(Integer.parseInt(this.foxySessionData.getPageParameter()) + 1));
        System.out.println("!!!! " + this.foxySessionData.getPageParameter());
        return ("success");
    }
    
    public String SubmitReport() {
        System.out.println(this.getFromDate());
        System.out.println(this.getToDate());
        System.out.println(this.getCountry());
        this.foxySessionData.setAction(LST);
        return ("success");
    }
    
    //PROPERTY: fromDate
    public String getFromDateDb(){
        SimpleDateFormat fmt = new SimpleDateFormat("yyyy-MM-dd");
        System.out.println(fmt.format(this.fromDate));
        return fmt.format(this.fromDate);
    }
    public Date getFromDate(){
        return this.fromDate;
    }
    public void setFromDate(Date newValue) {
        this.fromDate = newValue;
    }
    
    //PROPERTY: toDate
    public String getToDateDb(){
        SimpleDateFormat fmt = new SimpleDateFormat("yyyy-MM-dd");
        System.out.println(fmt.format(this.toDate));
        return fmt.format(this.toDate);
    }
    public Date getToDate(){
        return this.toDate;
    }
    public void setToDate(Date newValue) {
        this.toDate = newValue;
    }
    
    //PROPERTY: country
    public String getCountryName(){
        ListData ld = (ListData)getBean("listData");
        return(ld.getCountryDesc(this.getCountry(), 0));
        //return this.country;
    }
    public String getCountry(){
        return this.country;
    }
    public void setCountry(String newValue) {
        this.country = newValue;
    }
    
    //PROPERTY: merchandiser
    public String getMerchandiserName(){
        ListData ld = (ListData)getBean("listData");
        return(ld.getMerchandiser(this.getMerchandiser()).getFullName());
        //return this.country;
    }
    public String getMerchandiser(){
        return this.merchandiser;
    }
    public void setMerchandiser(String newValue) {
        this.merchandiser = newValue;
    }
    
    //PROPERTY: shipStat
    public String getShipStatD(){
        ListData ld = (ListData)getBean("listData");
        return(ld.getMerchandiser(this.getMerchandiser()).getFullName());
        //return this.country;
    }
    public String getShipStat(){
        return this.shipStat;
    }
    public void setShipStat(String newValue) {
        this.shipStat = newValue;
    }
}
